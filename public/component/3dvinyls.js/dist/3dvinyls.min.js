!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t:e.vinyls=t(e)}(this,function(e){"use strict";var t,n,o,i,s,a,r,l,c,E,h,d,m,u={},v={},T=!!document.querySelector&&!!e.addEventListener,y=[],p=[],w=!1,f=!1,g=!0,M={x:0,y:0},P={x:0,y:0},R=-1,H=-1,b=0,x={containerId:"vinyls",nbCrates:2,vinylsPerCrate:32,lightIntensity:1,cameraMouseMove:!0,callbackBefore:function(){},callbackAfter:function(){},constants:{vinylMoveTime:1e3,cameraMoveTime:800,cameraBasePosition:{x:230,y:210,z:110},cameraMouseMoveSpeedY:.05,cameraMouseMoveSpeedZ:.02}},I=function(e,t,n){this.id=e,this.crateId=t,this.pos=n,this.state="out",this.vinylXPos=-62+135/u.vinylsPerCrate*n,this.mesh=new THREE.Mesh(new THREE.BoxGeometry(100,1.5,100,1,1,1),new THREE.MeshFaceMaterial(F(null,!1))),this.mesh.geometry.applyMatrix((new THREE.Matrix4).makeTranslation(50,0,0)),this.mesh.position.set(this.vinylXPos,0,0),this.mesh.rotation.z=Math.PI/2,this.mesh.vinylId=e,this.mesh.visible=!1,this.absolutePosition=new THREE.Vector3,this.pushVinyl()};I.prototype.log=function(){console.log("Vinyl nÂ°",this.id,"crateId =",this.crateId,"pos =",this.pos)},I.prototype.showVinyl=function(){"shown"!==this.state&&(this.state="shown",this.absolutePosition.setFromMatrixPosition(this.mesh.matrixWorld),new TWEEN.Tween(this.mesh.position).to({y:25},u.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2},u.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(i.position).to({x:this.vinylXPos,y:75,z:this.absolutePosition.z},u.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(o.position).to({x:this.vinylXPos+140,y:190,z:this.absolutePosition.z+100},u.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},I.prototype.pushVinyl=function(){"pushed"!=this.state&&(this.state="pushed",new TWEEN.Tween(this.mesh.position).to({y:0},u.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2+Math.PI/7},u.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},I.prototype.pullVinyl=function(){"pulled"!==this.state&&(this.state="pulled",new TWEEN.Tween(this.mesh.position).to({y:0},u.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2-Math.PI/7},u.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start())};var W=function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},z=function(){g&&(requestAnimationFrame(z),N())},N=function(){TWEEN.update(),V(),u.cameraMouseMove&&(P.x=.25*(M.x/h-.5),P.y=.25*(M.y/h-.5),c.rotation.y+=u.constants.cameraMouseMoveSpeedY*(P.x-c.rotation.y),c.rotation.z+=u.constants.cameraMouseMoveSpeedZ*(P.y-c.rotation.z)),o.lookAt(i.position),s.render(n,o)},L=function(){for(var e=0;e<p.length;e++)p[e].data=null,p[e].mesh.visible=!1;b=0},O=function(e){b>0&&L();for(var t=0;t<p.length&&t<e.length;t++)p[t].data=e[t],p[t].mesh.visible=!0,p[t].mesh.material.materials=F(e[t].cover,!1);b=e.length<p.length?e.length:p.length,console.log("loadedVinyls",b)},V=function(){if(H!=R){H=R;for(var e=0;b>e;e++)-1==R?p[e].pushVinyl():e>R&&e>p[R].crateId*u.vinylsPerCrate&&e<p[R].crateId*u.vinylsPerCrate+u.vinylsPerCrate?p[e].pullVinyl():e==R?p[e].showVinyl():p[e].pushVinyl()}},B=function(){R=-1,new TWEEN.Tween(i.position).to({x:0,y:0,z:0},u.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(o.position).to({x:u.constants.cameraBasePosition.x,y:u.constants.cameraBasePosition.y,z:u.constants.cameraBasePosition.z},u.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start()},C=function(){-1==R?R=b-1:b-1>R?R+=1:R=0},j=function(){-1==R?R=0:R>0?R-=1:R=b-1},Q=function(e){var t=0,n=0,o=0,i=0,s=this;if(e||(e=window.event),e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),s.offsetParent)do o+=s.offsetLeft,i+=s.offsetTop;while(s=s.offsetParent);M.x=t-o,M.y=n-i},X=function(e){return U(e)<0?C():j(),!1},S=function(e){if(!w&&!f){var t=new THREE.Vector3((e.clientX-s.domElement.offsetLeft)/s.domElement.width*2-1,2*-((e.clientY-s.domElement.offsetTop)/s.domElement.height)+1,.5);a.unprojectVector(t,o);var n=new THREE.Raycaster(o.position,t.sub(o.position).normalize()),i=n.intersectObjects(E.children,!0);if(i.length>0&&i[0].object.vinylId>=0){var r=p[i[0].object.vinylId];"shown"==r.state||(R=r.id)}else R=-1;return!1}},G=function(){n=new THREE.Scene,s=new THREE.WebGLRenderer({antialias:!0}),s.setSize(h,d),t.appendChild(s.domElement),s.domElement.id="context",o=new THREE.PerspectiveCamera(45,h/d,.1,2e4),o.position.set(u.constants.cameraBasePosition.x,u.constants.cameraBasePosition.y,u.constants.cameraBasePosition.z),i=new THREE.Object3D,o.lookAt(i.position),a=new THREE.Projector,m=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("img/wood.jpg")}),c=new THREE.Object3D,E=new THREE.Object3D,n.add(c),c.add(E),Y(),k(),r=new THREE.PointLight(16777215,1.1*u.lightIntensity),r.position.set(175,90,0),n.add(r),l=new THREE.PointLight(16777215,.6*u.lightIntensity),l.position.set(200,150,1e3),n.add(l),s.domElement.addEventListener("DOMMouseScroll",X,!1),s.domElement.addEventListener("mousewheel",X,!1),s.domElement.addEventListener("mousemove",Q,!1),s.domElement.addEventListener("mousedown",S,!1),z()},Y=function(){for(var e=0;e<u.nbCrates;e++){var t=D(e);E.add(t)}E.position.z=-(110-110*u.nbCrates)/2},D=function(e){y[e]=new THREE.Object3D;var t=new THREE.Mesh(new THREE.BoxGeometry(200,10,100),m);y[e].add(t);var n=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),m);if(n.position.set(0,35,-55),n.rotation.x=Math.PI/2,y[e].add(n),0===e){var o=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),m);o.position.set(0,35,55),o.rotation.x=Math.PI/2,y[e].add(o)}var i=new THREE.Mesh(new THREE.BoxGeometry(80,10,120),m);i.position.set(-105,35,0),i.rotation.z=Math.PI/2,y[e].add(i);var s=new THREE.Mesh(new THREE.BoxGeometry(40,10,100),m);return s.position.set(95,25,0),s.rotation.z=Math.PI/2,y[e].add(s),y[e].position.z=-110*e,y[e]},k=function(){for(var e=0,t=0;t<y.length;t++)for(var n=0;n<u.vinylsPerCrate;n++)A(e,t,n),e++;console.log(p)},A=function(e,t,n){var o=new I(e,t,n);y[t].add(o.mesh),p.push(o)},F=function(e,t){var n=new Image;n.crossOrigin="Anonymous",n.src=e;var o=400,i=400,s=document.createElement("canvas");s.width=s.height=400;var a=new THREE.Texture(s);n.onload=function(){if(t){var e=new Image;e.src="sleeve.png",e.onload=function(){var t=s.getContext("2d");t.translate(o/2,i/2),t.rotate(Math.PI/2),t.translate(-o/2,-i/2),t.drawImage(n,166,166,180,180),t.drawImage(e,0,0,400,400),a.needsUpdate=!0}}else{var r=s.getContext("2d");r.translate(o/2,i/2),r.rotate(Math.PI/2),r.translate(-o/2,-i/2),r.drawImage(n,0,0,400,400),a.needsUpdate=!0}};var r=[new THREE.MeshLambertMaterial({color:1707525}),new THREE.MeshLambertMaterial({color:1707525}),new THREE.MeshLambertMaterial({color:1707525}),new THREE.MeshLambertMaterial({color:16777215,map:a}),new THREE.MeshLambertMaterial({color:1707525}),new THREE.MeshLambertMaterial({color:1707525})];return r},U=function(e){return e||(e=event),e.detail<0?1:e.wheelDelta>0?1:-1};return v.init=function(e){u=W(x,e),T&&Modernizr.webgl&&(console.log("initializing..."),console.log("options:",u),t=document.getElementById(u.containerId),h=u.canvasWidth?u.canvasWidth:t.offsetWidth,d=u.canvasHeight?u.canvasHeight:t.offsetHeight,console.log(t),G())},v.selectVinyl=function(e){0>e?B():R=e>b?b-1:e},v.startRender=function(){g=!0,z()},v.stopRender=function(){g=!1},v.loadVinyls=O,v.unloadVinyls=L,v});
